# Nucleoid Accessibility and Viscosity Quantificaiton Pipeline

This README describes how to run the `.mlx` scripts in `Acc_Vis_pipeline` in order, including dataloading , parameter setup, and expected outputs.

The pipeline scripts call helper functions from `Supporting_functions` , adding this folder to MATLAB path before running live scripts in `Acc_Vis_pipeline`. (includeing folder `Feret_analysis`)

## 1. Prerequisites
- This pipeline is tested on MATLAB R2024a
- toolbox needed: `Parallel Computing Toolbox`, `Statistics and Machine Learning Toolbox`, `Optimization Toolbox`, `Image Processing Toolbox`, `Curve Fitting Toolbox`,`Signal Processing Toolbox`
- [200 colormap](https://www.mathworks.com/matlabcentral/fileexchange/120088-200-colormap) from MATLAB Central File Exchange was used for plotting

Run scripts in the same MATLAB session, in order.

## 2. Data Requirements

The pipeline expects paired mask and tracking files per movie:

- Mask files: `*PhaseMask.mat` containing variable `PhaseMask`
  - Produced from segmentation by cellpose (PMID: 33318659, `Cell_segementation`).
- Tracking files: `*fits.mat` containing variables `tracks` and `fits`
  - Generated by SMALLLABS (PMID: 30846363, https://github.com/BiteenMatlab/SMALL-LABS).

Example dataset can be found at DOI [10.5281/zenodo.18599213](https://zenodo.org/records/18599214).

Optional macrodomain analysis needs ParB locus tracking localization maps (see Macrodomain_mask).

Results by this pipeline are stored in folder  `<dataset>\Result_yyyy_MM_dd`.

## 3. Run Order and Details

## 3.1 `Load_Filter_Data.mlx`

Purpose:
- Load mask/track/fits data
- Filter cells by morphology
- Compute localization fitting confidence interval

Set:
- `pixel_size = 49` (nm/pixel, adjust if needed)
- `num_pix_y = 20` (grids number in short-axis for heatmap results)
- Morphology filter selection:
  - `sel_filter` (2 length, 3 width, 4 aspect ratio, 5 area).
  - `bounds` = [low_bd, up_bd] for the chosen metric.

Main outputs in workspace:
- `Store_mask`, `Store_track`, `Store_fits`, `result_folder`
- `cell_morph`, `morph_by_mov`, `aspt_ratio`, `cell_avg_width`, `cellIndices`
- `locFitCI`, `locFitCI_UB`
- `Index = cellIndices`

Saved figures:
- `Cell Morphology Distribution`
- `Localization fitting CI`

---

## 3.2 `GetMap.mlx`

Purpose:
- Build localization heatmap and spatial displacement map (spMap)
- Determine cell and nucleoid boundaries


Main outputs:
- `raw_heatmap`, `htMap` 
  - normalized coordinates and localization heatmap
- `raw_spatialDisp`, `spMap`, `spMap_cnt`
  - length and normalized postion of each step, dispalcement map, number of steps in each grid
- `cell_outline`, `nuc_outline`
- `nuc_contour`, `cntr_up`, `cntr_low`
  - nucleoid outline determined by contour in spMap

Saved figures:
- `Heat map`
- `Spatial displacement map`
- `Heat map with boundaries`
- `Spatial displacement map with boundaries`
- `HeatMap with final boundaries`

---

## 3.3 `Init3DModel.mlx`

Purpose:
- Reconstruct 2D/3D geometry
  - Fit cell outline to a rod model and nucleoid outline to a piecewise function.
  - Build 3D geometry by rotational symmetry.

Set:
- `Ro = 5` (model cell radius in simulation units)
- Nucleoid boundary determined by spMap was used

Important outputs:
- `Rfit`, `Lfit`, `resd_avg`
- `Nuc_ratio_spMap`, `cell_para`, `nuc_para`
- `convert_factor`, `Lo`, `scaling_width`, `scaling_length`, `scale_bar`
- `anchor_spMap`, `kb_nuc_spMap`
  - anchor points of nucleoid with slope and intercept of piece-wise function that defines nucleoid morphology (by spMap)

Saved figures:
- `Reconstructed Geometry 2D`
  - Blue dash line indicates cell wall, and blue solid line indicates inner membrane (the boundary that nanocage is able to reach) 
  - Purple line is the nucleoid determined by spMap. The red dotted line is the nucleoid determined by heatmap for comparison 
- `Reconstructed Geometry 3D`
  - The blue solid line and purple line were used to reconstruct the 3D geometry

---

## 3.4 `Acc_and_VolNuc.mlx`

Purpose:
- Calculate nucleoid accessibility by similarity comparison between experimental and simulated heatmaps

Set:
- `acc_range = linspace(0,1,101)`
  - range of accessibilty for simulation (0~1)
- Simulation sample count in `Nuc_acc`: `2e6`

Main outputs:
- `acc_fit` (accessibility by fitting of the SSIM vs Acc plot)

Saved figures:
- `Accessibility Metric`
- `Error Heatmap`
- `Acc Heatmap Comparison`

---

## 3.5 `DynamicSimu.mlx`

Purpose:
- Run 3D Brownian Dynamics simulation and optimize parameters by grid search.

Set:
- `Num_run = 50`
- `StepSize_grid = 15:5:30` (step size in nm used for BD simulation)
- `Gap_grid = 10:5:250` (sampling interval)
- Score weights for similarity scoring: `score_w1 = 0.5`, `score_w2 = -120` 
  - optimal values for nanocage-tracking in *E. coli* (example in dataset mentioned in **Data Requirements**). When changing setup, these 2 weights need to be optmized based on comparison between experimental and simulated spMap

Main outputs:
- Region coordinates: `coord_in_nuc`, `coord_in_cyto`, `coord_out_cell`
- Selected best parameters: `sel_stepsize`, `sel_gap`
- Results from the best simulation: `Simu_spMap`, `Simu_spatialDisp`
  - length and normalized postion of each step, dispalcement map from the best BD simulation

Saved figures:
- `Map segmentation`
- `BD Simu optimization`
- `spMap comparison` (comparaison between experimental spMap and spMap of best BD simulation)

Files saved by `OrgResults` at end of this step:
- `Results.mat` (LocFit, CellMorph, Maps, Geometry, VolAccess, BDSim)
- `RawData.mat` (Store_mask, Store_fits, Store_track)

---

## 3.6 `Vis_Nuc_Cyto.mlx`

Purpose:
- Fit step-size distributions in nucleoid and cytoplasm
- Convert fitted diffusion to viscosity

Loads:
- `UnpackResults(result_folder)` (restores variables from `Results.mat`)

Set:
- `delta_t = 40` (ms)
- `temp_K = 303` (K)
- `probe_radius = 12.5e-9` (m)
- Nucleoid fit tolerance: `slack_d = 0.15`, `slack_acc = 0.075`

Main outputs:
- `Viscosity_nuc` (diffusion, viscosity, bounds)
- `Viscosity_cyto` (diffusion, viscosity, bounds)

Saved figures:
- `Nucleoid fit from simulation`
- `Nucleoid fit from experiment`
- `Cytoplasm fit`

Saved file:
- `VisNucCyto.mat`

---

## 3.7 Optional: `Vis_Nuc_Peri_vs_Core.mlx`

Purpose:
- Split nucleoid into periphery/core and compute viscosity separately

Set:
- Segmentation: `Nuc_Seg(...,[cntr_low+0.10, cntr_low],...)`
  - e.g. 10% margin added to contour line used to define nucleoid boudnary, such that nucleoid is partitioned into periphery (region between nucleoid contour and inner contour) and core (within the inner contour)
- Fit tolerances: `slack_d = 0.2`, `slack_acc = 0.1` (for both regions)

Main outputs:
- `Viscosity_peri`, `Viscosity_core`

Saved figures:
- `Periphery fit from simulation`
- `Periphery fit from experiment`
- `Core fit from simulation`
- `Core fit from experiment`

Saved file:
- `VisPeriCore.mat`

---

## 3.8 Optional: `Vis_Nuc_Macrodomain.mlx`

Purpose:
- Compute viscosity in a selected macrodomain Use macrodomain masks from ParB locus tracking results

Important load:
- Script currently hard-codes macrodomain outline:
  - load `Domain_outline` from  `...Macrodoamin_outline\Ter_boundary.mat`
- Macrodomain outline is produced from `Macrodomain_mask` workflows.

Set:
- `Domain_name = 'Terminus'` (controls output filename)
- Fit tolerances: `slack_d = 0.18`, `slack_acc = 0.075`

Main outputs:
- `Viscosity_domain`

Saved figures:
- `<Domain_name> fit from simulation`
- `<Domain_name> fit from experiment`

Saved file:
- `Vis<Domain_name>.mat`

---

## 3.9 `Btstrp_Analyze.mlx`

Purpose:
- Bootstrap uncertainty analysis for accessibility/viscosity outputs

Loads:
- `Results4Btstrp(result_folder)` to recover data and indices from `Results.mat` and `RawData.mat`

Set (compute resources and bootstrap design):
- `num_btstrp = 192`
- Parallel configuration (based on CPU cores).
  - `numWorkers = 16`
  - `num_per_loop = 12`
  - `max_parfor = 48`
- Bootstrap sample size in `Btstrp(...)`: `3600` cells per draw
- Hyperparameter ranges passed to `Btstrp_Sampling` based on results from **` DynamicSimu.mlx`**:
  - Step size: `25:5:35`
  - Gap: `80:5:110`
  - Score weights: `[0.5, -120]`

Main outputs:
- `Btstrp_Acc`, `Btstrp_Vis_Nuc`, `Btstrp_Vis_Cyto`
- `Btstrp_Vis_PeriCore`, `Btstrp_Vis_Domain`
- `Best_HyperPara` (hyperparameter chosen for each bootstrap run)
- `BtstrpResult`, `ind_pass`

Saved file:
- `BootstrapResult.mat`
  - Distributions for nucleoid accessibility and viscosity metrics.
  - Mean and standard deviation convergence plots.

## 4. Recommended Execution Pattern

1. Run `Load_Filter_Data.mlx` -> `GetMap.mlx` -> `Init3DModel.mlx` -> `Acc_and_VolNuc.mlx` -> `DynamicSimu.mlx`.
2. Run `Vis_Nuc_Cyto.mlx`.
3. Optionally run `Vis_Nuc_Peri_vs_Core.mlx` and/or `Vis_Nuc_Macrodomain.mlx`.
4. Run `Btstrp_Analyze.mlx`.

If you close MATLAB after step 5, resume with:

```matlab
UnpackResults(result_folder,'on')  % restores variables + raw data
```

## 5. Notes

- Keep `result_folder` consistent across all later scripts.
- Some scripts use hard-coded paths (e.g. macrodomain boundary). Update those paths to your environment before running.
- `Supporting_functions/Feret_analysis` contains third-party Feret-diameter tools by Steve Eddins (MathWorks), archived here because the original MathWorks File Exchange link is no longer accessible.
